# Licenses Overview API - Frontend Integration Guide

## Overview
The Licenses Overview API provides comprehensive analytics for all licenses with day-by-day usage statistics. This API follows the same pagination and response patterns as other admin analytics APIs.

## Base Information
- **Base URL**: `/api/admin/licenses/usage-overview`
- **Method**: GET
- **Authentication**: Admin JWT token required
- **Default Pagination**: 20 items per page (consistent with other analytics APIs)

## Request Parameters

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `days` | number | 30 | Number of days to analyze |
| `limit` | number | 20 | Number of results per page |
| `offset` | number | 0 | Number of results to skip |
| `osgb_id` | string | - | Filter by specific OSGB ID |
| `include_inactive` | boolean | true | Include expired licenses |
| `include_daily` | boolean | false | Include detailed daily usage breakdown |

## Frontend Integration Examples

### 1. Basic Request (Default Pagination)

```javascript
// Fetch first 20 licenses with 30-day analysis
const fetchLicensesOverview = async () => {
  try {
    const response = await fetch('/api/admin/licenses/usage-overview', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${adminToken}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    return data;
  } catch (error) {
    console.error('Error fetching licenses overview:', error);
    throw error;
  }
};
```

**Example Response:**
```json
{
  "success": true,
  "data": [
    {
      "license_code": "7539047788",
      "osgb_id": "OSGB-5014",
      "company_name": "Örnek Şirket A.Ş.",
      "status": "active",
      "created_at": "2026-01-01T10:00:00.000Z",
      "expires_at": "2026-01-08T10:00:00.000Z",
      "total_usage_count": 45,
      "days_used": 5,
      "avg_daily_usage": 9.0,
      "first_used": "2026-01-02T08:30:00.000Z",
      "last_used": "2026-01-05T16:45:00.000Z",
      "usage_streak": 3,
      "daily_usage": null
    }
  ],
  "meta": {
    "count": 20,
    "limit": 20,
    "offset": 0,
    "total": 130,
    "has_next": true,
    "has_prev": false,
    "analysis_period": {
      "days": 30,
      "start_date": "2025-12-06",
      "end_date": "2026-01-05"
    }
  }
}
```

### 2. Pagination Implementation

```javascript
// React component example for pagination
const LicensesOverviewTable = () => {
  const [licenses, setLicenses] = useState([]);
  const [pagination, setPagination] = useState({
    limit: 20,
    offset: 0,
    total: 0,
    has_next: false,
    has_prev: false
  });
  const [loading, setLoading] = useState(false);

  const fetchLicenses = async (limit = 20, offset = 0) => {
    setLoading(true);
    try {
      const response = await fetch(
        `/api/admin/licenses/usage-overview?limit=${limit}&offset=${offset}`,
        {
          headers: {
            'Authorization': `Bearer ${adminToken}`,
            'Content-Type': 'application/json'
          }
        }
      );
      
      const data = await response.json();
      
      if (data.success) {
        setLicenses(data.data);
        setPagination({
          limit: data.meta.limit,
          offset: data.meta.offset,
          total: data.meta.total,
          has_next: data.meta.has_next,
          has_prev: data.meta.has_prev
        });
      }
    } catch (error) {
      console.error('Error:', error);
    } finally {
      setLoading(false);
    }
  };

  // Pagination handlers
  const goToNextPage = () => {
    if (pagination.has_next) {
      fetchLicenses(pagination.limit, pagination.offset + pagination.limit);
    }
  };

  const goToPrevPage = () => {
    if (pagination.has_prev) {
      fetchLicenses(pagination.limit, pagination.offset - pagination.limit);
    }
  };

  const goToPage = (page) => {
    const newOffset = (page - 1) * pagination.limit;
    fetchLicenses(pagination.limit, newOffset);
  };

  useEffect(() => {
    fetchLicenses();
  }, []);

  // Component render logic here...
};
```

### 3. Advanced Filtering Examples

```javascript
// Filter by specific OSGB ID
const fetchSpecificOSGB = async (osgbId) => {
  const response = await fetch(
    `/api/admin/licenses/usage-overview?osgb_id=${osgbId}&include_daily=true`,
    {
      headers: {
        'Authorization': `Bearer ${adminToken}`,
        'Content-Type': 'application/json'
      }
    }
  );
  
  return await response.json();
};

// Get active licenses only for last 7 days
const fetchActiveLicenses = async () => {
  const response = await fetch(
    '/api/admin/licenses/usage-overview?days=7&include_inactive=false&limit=50',
    {
      headers: {
        'Authorization': `Bearer ${adminToken}`,
        'Content-Type': 'application/json'
      }
    }
  );
  
  return await response.json();
};

// Search with custom parameters
const searchLicenses = async (filters) => {
  const params = new URLSearchParams();
  
  if (filters.days) params.append('days', filters.days);
  if (filters.osgbId) params.append('osgb_id', filters.osgbId);
  if (filters.includeInactive !== undefined) {
    params.append('include_inactive', filters.includeInactive);
  }
  if (filters.includeDaily) params.append('include_daily', 'true');
  if (filters.limit) params.append('limit', filters.limit);
  if (filters.offset) params.append('offset', filters.offset);
  
  const response = await fetch(
    `/api/admin/licenses/usage-overview?${params.toString()}`,
    {
      headers: {
        'Authorization': `Bearer ${adminToken}`,
        'Content-Type': 'application/json'
      }
    }
  );
  
  return await response.json();
};
```

### 4. Daily Usage Details

```javascript
// Fetch license with detailed daily usage breakdown
const fetchLicenseWithDailyUsage = async (osgbId) => {
  const response = await fetch(
    `/api/admin/licenses/usage-overview?osgb_id=${osgbId}&include_daily=true`,
    {
      headers: {
        'Authorization': `Bearer ${adminToken}`,
        'Content-Type': 'application/json'
      }
    }
  );
  
  const data = await response.json();
  return data;
};
```

**Example Response with Daily Usage:**
```json
{
  "success": true,
  "data": [
    {
      "license_code": "7539047788",
      "osgb_id": "OSGB-5014",
      "company_name": "Örnek Şirket A.Ş.",
      "status": "active",
      "total_usage_count": 45,
      "days_used": 5,
      "avg_daily_usage": 9.0,
      "daily_usage": {
        "2026-01-01": 8,
        "2026-01-02": 12,
        "2026-01-03": 10,
        "2026-01-04": 7,
        "2026-01-05": 8
      }
    }
  ],
  "meta": {
    "count": 1,
    "total": 1,
    "analysis_period": {
      "days": 30,
      "start_date": "2025-12-06",
      "end_date": "2026-01-05"
    }
  }
}
```

### 5. Error Handling

```javascript
const handleAPIErrors = async (response) => {
  if (!response.ok) {
    if (response.status === 401) {
      throw new Error('Authentication failed. Please login again.');
    } else if (response.status === 403) {
      throw new Error('Access denied. Admin privileges required.');
    } else if (response.status === 404) {
      throw new Error('API endpoint not found.');
    } else if (response.status >= 500) {
      throw new Error('Server error. Please try again later.');
    } else {
      throw new Error(`Request failed with status: ${response.status}`);
    }
  }
  
  const data = await response.json();
  
  if (!data.success) {
    throw new Error(data.message || 'Request failed');
  }
  
  return data;
};

// Usage with error handling
const fetchLicensesWithErrorHandling = async () => {
  try {
    const response = await fetch('/api/admin/licenses/usage-overview', {
      headers: {
        'Authorization': `Bearer ${adminToken}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await handleAPIErrors(response);
    return data;
    
  } catch (error) {
    console.error('License fetch error:', error.message);
    
    // Show user-friendly error message
    showErrorNotification(error.message);
    
    // Return empty state for UI
    return {
      success: false,
      data: [],
      meta: { count: 0, total: 0, limit: 20, offset: 0 }
    };
  }
};
```

### 6. React Hook Example

```javascript
// Custom hook for licenses overview
const useLicensesOverview = (initialFilters = {}) => {
  const [licenses, setLicenses] = useState([]);
  const [meta, setMeta] = useState({});
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  
  const fetchLicenses = useCallback(async (filters = {}) => {
    setLoading(true);
    setError(null);
    
    try {
      const params = new URLSearchParams({
        limit: 20,
        offset: 0,
        days: 30,
        include_inactive: 'true',
        ...initialFilters,
        ...filters
      });
      
      const response = await fetch(
        `/api/admin/licenses/usage-overview?${params.toString()}`,
        {
          headers: {
            'Authorization': `Bearer ${getAdminToken()}`,
            'Content-Type': 'application/json'
          }
        }
      );
      
      const data = await handleAPIErrors(response);
      
      setLicenses(data.data);
      setMeta(data.meta);
      
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  }, [initialFilters]);
  
  const refresh = () => fetchLicenses();
  
  const changePage = (page) => {
    const offset = (page - 1) * (meta.limit || 20);
    fetchLicenses({ offset });
  };
  
  const applyFilters = (newFilters) => {
    fetchLicenses({ offset: 0, ...newFilters });
  };
  
  useEffect(() => {
    fetchLicenses();
  }, [fetchLicenses]);
  
  return {
    licenses,
    meta,
    loading,
    error,
    refresh,
    changePage,
    applyFilters
  };
};

// Usage in component
const LicensesComponent = () => {
  const {
    licenses,
    meta,
    loading,
    error,
    changePage,
    applyFilters
  } = useLicensesOverview({ days: 7 });
  
  if (loading) return <div>Loading...</div>;
  if (error) return <div>Error: {error}</div>;
  
  return (
    <div>
      {/* Filters */}
      <button onClick={() => applyFilters({ days: 7, include_inactive: false })}>
        Active Licenses (7 days)
      </button>
      
      {/* Table */}
      <table>
        {licenses.map(license => (
          <tr key={license.license_code}>
            <td>{license.osgb_id}</td>
            <td>{license.company_name}</td>
            <td>{license.total_usage_count}</td>
            <td>{license.status}</td>
          </tr>
        ))}
      </table>
      
      {/* Pagination */}
      <div>
        <button 
          disabled={!meta.has_prev} 
          onClick={() => changePage(Math.floor(meta.offset / meta.limit))}
        >
          Previous
        </button>
        
        <span>
          Page {Math.floor(meta.offset / meta.limit) + 1} of {Math.ceil(meta.total / meta.limit)}
        </span>
        
        <button 
          disabled={!meta.has_next}
          onClick={() => changePage(Math.floor(meta.offset / meta.limit) + 2)}
        >
          Next
        </button>
      </div>
    </div>
  );
};
```

### 7. URL Examples for Testing

```javascript
// Test URLs you can use in browser or Postman:

// Basic request (first 20 licenses, 30-day analysis)
GET /api/admin/licenses/usage-overview

// Custom pagination
GET /api/admin/licenses/usage-overview?limit=5&offset=10

// Filter by specific OSGB
GET /api/admin/licenses/usage-overview?osgb_id=OSGB-5014

// Daily usage details for specific OSGB
GET /api/admin/licenses/usage-overview?osgb_id=OSGB-5014&include_daily=true

// Active licenses only, last 7 days
GET /api/admin/licenses/usage-overview?days=7&include_inactive=false

// Large page size for exports
GET /api/admin/licenses/usage-overview?limit=100&offset=0

// Complex filtering
GET /api/admin/licenses/usage-overview?days=14&include_inactive=false&include_daily=true&limit=10
```

## Response Schema

### Success Response
```typescript
interface LicensesOverviewResponse {
  success: true;
  data: LicenseWithUsage[];
  meta: {
    count: number;           // Number of items in current response
    limit: number;           // Page size
    offset: number;          // Current offset
    total: number;           // Total items available
    has_next: boolean;       // Has next page
    has_prev: boolean;       // Has previous page
    analysis_period: {
      days: number;          // Analysis period in days
      start_date: string;    // Start date (YYYY-MM-DD)
      end_date: string;      // End date (YYYY-MM-DD)
    };
  };
}

interface LicenseWithUsage {
  license_code: string;
  osgb_id: string;
  company_name: string;
  status: 'active' | 'expired';
  created_at: string;        // ISO date
  expires_at: string;        // ISO date
  total_usage_count: number;
  days_used: number;
  avg_daily_usage: number;
  first_used: string | null; // ISO date
  last_used: string | null;  // ISO date
  usage_streak: number;
  daily_usage?: {            // Only when include_daily=true
    [date: string]: number;  // "YYYY-MM-DD": usage_count
  };
}
```

### Error Response
```typescript
interface ErrorResponse {
  success: false;
  message: string;
  error?: any;
}
```

## Best Practices

1. **Always handle pagination** - The API returns max 20 items by default
2. **Use error handling** - Check response status and handle errors gracefully
3. **Cache when appropriate** - License data doesn't change frequently
4. **Use loading states** - API calls may take time for large datasets
5. **Respect rate limits** - Don't make too many concurrent requests
6. **Include daily details sparingly** - Use `include_daily=true` only when needed (larger response)

## Performance Tips

- Use smaller page sizes (`limit=10`) for faster initial loads
- Only request daily usage breakdown when displaying charts/details
- Filter by `include_inactive=false` if you only need active licenses
- Use shorter analysis periods (`days=7`) for faster queries
- Consider caching results for dashboard views

## Integration Checklist

- [ ] Authentication token management
- [ ] Pagination implementation
- [ ] Error handling
- [ ] Loading states
- [ ] Filter controls
- [ ] Export functionality (if needed)
- [ ] Responsive design for license tables
- [ ] Daily usage chart integration (when using `include_daily=true`)